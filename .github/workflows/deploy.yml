name: CI/CD Node.js App with ECR & Rollback

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPO: ${{ secrets.ECR_REPO }}
  IMAGE_TAG: ${{ github.sha }}
  ECR_URI: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPO }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install dependencies
      run: npm ci

    # Uncomment once tests are stable
    # - name: Run tests
    #   run: npm test

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build Docker image
      run: |
        docker build -t $ECR_URI:$IMAGE_TAG .

    - name: Push Docker image
      run: |
        docker push $ECR_URI:$IMAGE_TAG

    - name: Deploy via AWS SSM
      run: |
        aws ssm send-command \
          --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
          --document-name "AWS-RunShellScript" \
          --comment "Deploy Node.js app" \
          --parameters commands='[
            "set -e",
            "APP_NAME=node-app",
            "NEW_IMAGE='"$ECR_URI:$IMAGE_TAG"'",
            "",
            "echo Pulling new image",
            "docker pull $NEW_IMAGE",
            "",
            "echo Removing ALL old containers",
            "docker ps -aq --filter name=$APP_NAME | xargs -r docker rm -f",
            "",
            "echo Starting new container",
            "docker run -d --name $APP_NAME -p 3000:3000 --restart always $NEW_IMAGE",
            "",
            "sleep 10",
            "",
            "echo Validating application",
            "curl -f http://localhost:3000/health || exit 1",
            "",
            "echo Deployment successful"
          ]' \
          --timeout-seconds 600
